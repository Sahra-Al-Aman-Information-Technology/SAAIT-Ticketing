<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Streams</title>
<link rel="stylesheet" href="/static/styles.css">
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #f4f6f9;
        color: #333;
    }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
    table {
        width: 100%; border-collapse: collapse; margin-top: 20px;
        background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border-radius: 8px; overflow: hidden;
    }
    th, td {
        padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-size: 14px;
    }
    th { background-color: #007bff; color: white; font-weight: 600; text-transform: uppercase; }
    tr:nth-child(even) { background-color: #f9fbfd; }
    tr:hover { background-color: #eef6ff; }
    button {
        padding: 6px 12px; margin: 2px; border: none; border-radius: 4px;
        cursor: pointer; transition: 0.2s; font-size: 13px;
    }
    button:hover { opacity: 0.9; }
    .edit-btn { background-color: #28a745; color: white; }
    .delete-btn { background-color: #dc3545; color: white; }
    .save-btn { background-color: #ffc107; color: black; }
    .cancel-btn { background-color: #6c757d; color: white; }
    .gallery {
        border: 1px solid #ddd; padding: 20px; margin-top: 40px; background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 8px;
    }
    .gallery h3 {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; color: #007bff;
    }
    .add-btn { background-color: #28a745; color: white; padding: 6px 14px; font-size: 14px; border-radius: 4px; }
    .add-btn:hover { background-color: #218838; }
    .modal {
        display: none; position: fixed; z-index: 1000; padding-top: 100px; left: 0; top: 0;
        width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fff; margin: auto; padding: 20px; border-radius: 8px;
        width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    .modal-content label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; }
    .modal-content input, .modal-content select {
        width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 12px;
        border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
    }
    .modal-content button {
        background-color: #007bff; color: white; padding: 10px; width: 100%;
        border: none; border-radius: 4px; cursor: pointer; font-size: 15px;
    }
    .modal-content button:hover { background-color: #0056b3; }
    .close { color: #aaa; float: right; font-size: 22px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #000; }
 
    #backBtn {
        background-color: black;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }
    #backBtn:hover {
        background-color: white;
        color: black;
        border: 1px solid black;
    }
</style>
</head>
<body>
 
<button id="backBtn" onclick="window.history.back()">⬅ Back</button>
<h2>Streams</h2>
 
<!-- Project Table -->
<table id="projectTable">
    <thead>
        <tr>
            <th>Project ID</th>
            <th>Project Name</th>
            <th>Client</th>
            <th>Create Date</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
 
<!-- Stream 1 Gallery -->
<div class="gallery" id="stream1Gallery">
    <h3>
        Stream 1
        <button class="add-btn" id="addStream1Btn">Add Stream 1</button>
    </h3>
    <table id="stream1Table">
        <thead>
            <tr>
                <th>Stream ID</th>
                <th>Stream 1</th>
                <th>Created Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
 
<!-- Stream 2 Gallery -->
<div class="gallery" id="stream2Gallery">
    <h3>
        Stream 2
        <button class="add-btn" id="addStream2Btn" style="display:none;">Add Stream 2</button>
    </h3>
    <table id="stream2Table">
        <thead>
            <tr>
                <th>Stream ID</th>
                <th>Stream 1</th>
                <th>Stream 2</th>
                <th>Created Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
 
<!-- Stream 1 Modal -->
<div id="stream1Modal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeStream1">&times;</span>
        <h3>Add Stream 1</h3>
        <label>Stream 1 Name</label>
        <input type="text" id="stream1Input">
        <button id="saveStream1">Save</button>
    </div>
</div>
 
<!-- Stream 2 Modal -->
<div id="stream2Modal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeStream2">&times;</span>
        <h3>Add Stream 2</h3>
        <label>Select Stream 1</label>
        <select id="stream1Dropdown"></select>
        <label>Stream 2 Name</label>
        <input type="text" id="stream2Input">
        <button id="saveStream2">Save</button>
    </div>
</div>
 
<script>
const params = new URLSearchParams(window.location.search);
const projectID = params.get("project_id");
let projectClientID = null;
if(!projectID) alert("Project ID missing!");
 
// Load Project Table
async function loadProjectRecord() {
    try {
        const response = await fetch(`/get_project_by_id?project_id=${projectID}`);
        const data = await response.json();
        const tbody = document.querySelector("#projectTable tbody");
        tbody.innerHTML = "";
 
        if(data.success && data.project) {
            const p = data.project;
            projectClientID = p.ClientID;
            tbody.innerHTML = `
                <tr id="row-${p.ProjectID}">
                    <td>${p.ProjectID}</td>
                    <td id="name-${p.ProjectID}">${p.ProjectName}</td>
                    <td id="client-${p.ProjectID}" data-clientid="${p.ClientID}">${p.ClientName}</td>
                    <td id="date-${p.ProjectID}">${p.CreatedDate ? p.CreatedDate.split("T")[0] : ""}</td>
                    <td id="status-${p.ProjectID}">${p.Status}</td>
                    <td>
                        <button class="edit-btn" onclick="editProject(${p.ProjectID})">Edit</button>
                        ${p.Status === "Inactive" ? `<button class="delete-btn" onclick="deleteProject(${p.ProjectID})">Delete</button>` : ""}
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = "<tr><td colspan='6'>No records found</td></tr>";
        }
    } catch(err){ console.error(err); }
}
 
// Edit Project
function editProject(id) {
    const name = document.getElementById(`name-${id}`).innerText;
    const date = document.getElementById(`date-${id}`).innerText;
    const status = document.getElementById(`status-${id}`).innerText;
 
    document.getElementById(`name-${id}`).innerHTML = `<input type="text" id="input-name-${id}" value="${name}">`;
    document.getElementById(`date-${id}`).innerHTML = `<input type="date" id="input-date-${id}" value="${date}">`;
    document.getElementById(`status-${id}`).innerHTML = `
        <select id="input-status-${id}">
            <option value="Active" ${status==="Active"?"selected":""}>Active</option>
            <option value="Inactive" ${status==="Inactive"?"selected":""}>Inactive</option>
        </select>
    `;
    const actionCell = document.querySelector(`#row-${id} td:last-child`);
    actionCell.innerHTML = `
        <button class="save-btn" onclick="saveProject(${id})">Save</button>
        <button class="cancel-btn" onclick="loadProjectRecord()">Cancel</button>
    `;
}
 
// Save Project
async function saveProject(id) {
    const name = document.getElementById(`input-name-${id}`).value;
    const clientID = document.getElementById(`client-${id}`).dataset.clientid;
    const date = document.getElementById(`input-date-${id}`).value;
    const status = document.getElementById(`input-status-${id}`).value;
 
    const formData = new FormData();
    formData.append("ProjectID", id);
    formData.append("ProjectName", name);
    formData.append("ClientID", clientID);
    formData.append("CreatedDate", date);
    formData.append("Status", status);
 
    try {
        const response = await fetch("/edit_project", { method:"POST", body: formData });
        const result = await response.json();
        if(result.success) {
            alert("Project updated successfully!");
            loadProjectRecord();
        } else alert("Error: "+result.message);
    } catch(err){ console.error(err); }
}
 
// ✅ Delete Project (Soft Delete)
async function deleteProject(id) {
    if(!confirm("Are you sure you want to delete this project?")) return;
 
    try {
        const res = await fetch(`/soft_delete_project/${id}`, { method: "POST" });
        const result = await res.json();
 
        if(result.success) {
            const row = document.getElementById(`row-${id}`);
            if(row) row.remove(); // Remove from screen
            alert("Project marked as deleted successfully.");
        } else {
            alert(result.message || "Error deleting project.");
        }
    } catch(err){ console.error(err); alert("Error deleting project."); }
}
 
// Stream1 Modal
const stream1Modal = document.getElementById("stream1Modal");
document.getElementById("addStream1Btn").onclick = () => stream1Modal.style.display = "block";
document.getElementById("closeStream1").onclick = () => stream1Modal.style.display = "none";
 
// Stream2 Modal
const stream2Modal = document.getElementById("stream2Modal");
document.getElementById("addStream2Btn").onclick = () => stream2Modal.style.display = "block";
document.getElementById("closeStream2").onclick = () => stream2Modal.style.display = "none";
 
// Add Stream1
document.getElementById("saveStream1").onclick = async () => {
    const name = document.getElementById("stream1Input").value.trim();
    if(!name) return alert("Enter Stream1");
 
    const resCheck = await fetch(`/get_stream1/${projectID}`);
    const existing = await resCheck.json();
    const isDuplicate = existing.some(s => s.Stream1.toLowerCase() === name.toLowerCase());
    if(isDuplicate) return alert("Stream 1 already exists!");
 
    const res = await fetch("/add_stream1", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ project_id: projectID, stream1:name, created_date:new Date().toISOString(), client_id: projectClientID })
    });
    const data = await res.json();
    if(data.success) { stream1Modal.style.display="none"; document.getElementById("stream1Input").value=""; loadStream1(); }
    else alert(data.message);
};
 
// Add Stream2
document.getElementById("saveStream2").onclick = async () => {
    const stream1_id = document.getElementById("stream1Dropdown").value;
    const stream2 = document.getElementById("stream2Input").value;
    if(!stream1_id || !stream2) return alert("Select Stream1 and enter Stream2");
    const res = await fetch("/add_stream2", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ project_id: projectID, stream1_id, stream2, created_date:new Date().toISOString(), client_id: projectClientID })
    });
    const data = await res.json();
    if(data.success) { stream2Modal.style.display="none"; document.getElementById("stream2Input").value=""; loadStream2(); }
    else alert(data.message);
};
 
// Load Stream1
async function loadStream1() {
    const res = await fetch(`/get_stream1/${projectID}`);
    const stream1Data = await res.json();
 
    const res2 = await fetch(`/get_stream2/${projectID}`);
    const stream2Data = await res2.json();
    const usedStream1IDs = stream2Data.map(s => s.Stream1);
 
    const tbody = document.querySelector("#stream1Table tbody");
    tbody.innerHTML = "";
    const dropdown = document.getElementById("stream1Dropdown");
    dropdown.innerHTML = "";
 
    if(stream1Data.length===0) document.getElementById("addStream2Btn").style.display="none";
    else document.getElementById("addStream2Btn").style.display="inline-block";
 
    stream1Data.forEach(s=>{
        const tr = document.createElement("tr");
        tr.id = `stream1-row-${s.StreamID}`;
        const isUsed = usedStream1IDs.includes(s.StreamID) || usedStream1IDs.includes(s.Stream1);
        tr.innerHTML = `
            <td>${s.StreamID}</td>
            <td>${s.Stream1}</td>
            <td>${new Date().toISOString().split('T')[0]}</td>
            <td>${isUsed ? "" : `<button class="delete-btn" onclick="deleteStream(${s.StreamID})">Delete</button>`}</td>
        `;
        tbody.appendChild(tr);
        const opt = document.createElement("option"); opt.value = s.StreamID; opt.text = s.Stream1;
        dropdown.add(opt);
    });
}
 
// Load Stream2
async function loadStream2() {
    const res = await fetch(`/get_stream2/${projectID}`);
    const data = await res.json();
    const tbody = document.querySelector("#stream2Table tbody");
    tbody.innerHTML = "";
    data.forEach(s=>{
        const tr = document.createElement("tr");
        tr.id = `stream2-row-${s.StreamID}`;
        tr.innerHTML = `
            <td>${s.StreamID}</td>
            <td>${s.Stream1}</td>
            <td>${s.Stream2}</td>
            <td>${new Date().toISOString().split('T')[0]}</td>
            <td><button class="delete-btn" onclick="deleteStream(${s.StreamID})">Delete</button></td>
        `;
        tbody.appendChild(tr);
    });
}
 
// Delete Stream
async function deleteStream(id) {
    if(!confirm("Are you sure you want to delete this stream?")) return;
    try {
        const res = await fetch(`/delete_stream?StreamID=${id}`, { method:"DELETE" });
        const data = await res.json();
        if(data.success) {
            const row1 = document.getElementById(`stream1-row-${id}`);
            if(row1) row1.remove();
            const row2 = document.getElementById(`stream2-row-${id}`);
            if(row2) row2.remove();
            loadStream1();
            alert("Stream deleted successfully!");
        } else alert("Error: "+data.message);
    } catch(err){ console.error(err); }
}
 
// Close modals on click outside
window.onclick = e => {
    if(e.target==stream1Modal) stream1Modal.style.display = "none";
    if(e.target==stream2Modal) stream2Modal.style.display = "none";
}
 
window.onload = () => { loadProjectRecord(); loadStream1(); loadStream2(); }
</script>
 
</body>
</html>
 
 