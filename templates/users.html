<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Management • SAAIT</title>
  <style>

    body {

      font-family: Arial, sans-serif;

      margin: 0;

      background: #f4f4f9;

    }

    header {

      background: #010b13;

      color: white;

      padding: 12px;

      text-align: center;

      font-size: 20px;

      font-weight: bold;

    }

    .container {

      max-width: 1000px;

      margin: 20px auto;

      background: white;

      padding: 20px;

      border-radius: 8px;

      box-shadow: 0 0 10px #ccc;

    }

    .toolbar {

      display: flex;

      justify-content: space-between;

      align-items: center;

      margin-bottom: 15px;

      gap: 10px;

    }

    .toolbar button {

      padding: 8px 14px;

      border: none;

      border-radius: 6px;

      cursor: pointer;

      font-size: 14px;

    }

    .btn {

      padding: 6px 12px;

      border: none;

      border-radius: 6px;

      cursor: pointer;

      font-size: 14px;

      font-weight: 500;

      transition: background 0.3s, transform 0.1s;

    }

    .btn:hover {

      transform: translateY(-1px);

    }

    .btn-success {

      background: #28a745;

      color: white;

    }

    .btn-success:hover {

      background: #218838;

    }

    .btn-secondary {

      background: #6c757d;

      color: white;

    }

    .btn-secondary:hover {

      background: #5a6268;

    }

    .btn-danger {

      background: #dc3545;

      color: white;

    }

    .btn-danger:hover {

      background: #c82333;

    }
 
    table {

      width: 100%;

      border-collapse: collapse;

    }

    th, td {

      padding: 10px;

      border-bottom: 1px solid #ddd;

      text-align: center;

    }

    th {

      background: #f8f8f8;

    }
 
    /* Modal */

    .modal {

      display: none;

      position: fixed;

      top: 0; left: 0;

      width: 100%; height: 100%;

      background: rgba(0,0,0,0.5);

      justify-content: center;

      align-items: center;

      z-index: 2000;

    }

    .modal-content {

      background: white;

      padding: 25px 30px;   /* more side padding */

      border-radius: 8px;

      width: 400px;

      max-width: 95%;

      box-shadow: 0 0 10px #333;

      box-sizing: border-box;

    }

    .modal-content h3 {

      margin-top: 0;

      margin-bottom: 12px;

      text-align: center;

    }

    .modal-content input {

      width: 100%;

      padding: 10px;

      margin: 8px 0;

      border: 1px solid #ccc;

      border-radius: 6px;

      box-sizing: border-box;  /* ensures inputs don't overflow */

    }

    .modal-footer {

      display: flex;

      justify-content: flex-end;

      margin-top: 15px;

      gap: 10px;

    }
</style>

 
</head>
<body>
  <header>User Management</header>

  <div class="container">
    <div class="toolbar">
     <button class="btn btn-secondary" onclick="window.location.href='/Saait.html'">← Back</button>
<button class="btn btn-success" onclick="document.getElementById('addUserModal').style.display='flex'">+ Add User</button>


    </div>

    <table>
      <thead>
        <tr>
          <th>Id</th>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>

 <!-- Add User Modal -->
<div id="addUserModal" class="modal">
<div class="modal-content">
<h3 style="text-align:center; margin-bottom:15px;">Add User</h3>
 
    <!-- Full Name -->
<input type="text" id="newUserName" placeholder="Full Name"

      style="width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:6px;">
 
    <!-- Client Dropdown -->
<select id="newUserClient" required

      style="width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:6px;">
<option value="">Select Client</option>
<!-- Options populated dynamically -->
</select>
 
    <!-- Project Dropdown -->
<select id="newUserProject" required

      style="width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:6px;">
<option value="">Select Project</option>
<!-- Options populated dynamically -->
</select>
 
    <!-- Role Type Checkboxes -->
<div style="margin-top:15px; margin-bottom:15px;">
<label style="font-weight:600; display:block; margin-bottom:5px;">Role Type:</label>
<div style="display:flex; align-items:center; gap:20px;">
<label style="display:flex; align-items:center; gap:6px;">
<input type="checkbox" id="isRaisedBy"> Raised By
</label>
<label style="display:flex; align-items:center; gap:6px;">
<input type="checkbox" id="isAssignedTo"> Assigned To
</label>
</div>
</div>
 
    <!-- Modal Footer -->
<div class="modal-footer" style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
<button class="btn btn-secondary" type="button"

        onclick="document.getElementById('addUserModal').style.display='none'">

        Cancel
</button>
<button class="btn btn-success" id="addUserSubmitBtn" type="button" onclick="addUser()">

        Save
</button>
</div>
</div>
</div>

 
  <script>
    async function loadUsers() {
      const res = await fetch('/saait_users');
      const users = await res.json();
      const tbody = document.getElementById('userTable');
      tbody.innerHTML = '';
      users.forEach((u, idx) => {
        tbody.innerHTML += `
          <tr>
            <td>${idx+1}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.status}</td>
            <td>
              <button class="btn btn-danger" onclick="deleteUser(${u.id})">Delete</button>

            </td>
          </tr>
        `;
      });
    }

   async function addUser() {

  const name = document.getElementById('newUserName').value.trim();

  const clientId = document.getElementById('newUserClient').value;

  const projectId = document.getElementById('newUserProject').value;
 
  // ✅ Role type checkboxes

  const isRaisedBy = document.getElementById('isRaisedBy')?.checked ? 1 : 0;

  const isAssignedTo = document.getElementById('isAssignedTo')?.checked ? 1 : 0;
 
  // ✅ Validate required fields (email/password removed)

  if (!name || !clientId || !projectId) {

    alert('⚠️ All fields including client and project are required.');

    return;

  }
 
  try {

    // Disable Save button during submission

    const submitBtn = document.getElementById('addUserSubmitBtn');

    if (submitBtn) submitBtn.disabled = true;
 
    // ✅ Send data to backend (no email/password)

    const res = await fetch('/add_saait_user', {

      method: 'POST',

      headers: { 'Content-Type': 'application/json' },

      body: JSON.stringify({

        name,

        clientId,

        projectId,

        isRaisedBy,

        isAssignedTo

      })

    });
 
    if (!res.ok) {

      const errorData = await res.json().catch(() => ({}));

      const errMsg = errorData.error || `Server error (${res.status})`;

      alert(`❌ Failed to add user: ${errMsg}`);

      return;

    }
 
    const data = await res.json();
 
    if (data.message) {

      alert('✅ User added successfully!');

      document.getElementById('addUserModal').style.display = 'none';

      loadUsers(); // Refresh table

    } else {

      alert(`⚠️ Unexpected response: ${JSON.stringify(data)}`);

    }

  } catch (err) {

    console.error('❌ Error adding user:', err);

    alert('❌ Network or server error occurred. Please try again.');

  } finally {

    const submitBtn = document.getElementById('addUserSubmitBtn');

    if (submitBtn) submitBtn.disabled = false;

  }

}

 
 



    async function deleteUser(id) {
      if (!confirm("Delete this user?")) return;
      await fetch(`/delete_saait_user/${id}`, {method:'DELETE'});
      loadUsers();
    }
    


  // Load all clients when opening Add User Modal
// Load clients dynamically when Add User modal opens
// Load all clients when Add User modal opens
// Load all clients when Add User modal opens
async function loadClientsForUserModal() {
    try {
        const res = await fetch('/get_clients');
        const clients = await res.json();
        const clientDropdown = document.getElementById('newUserClient');
        clientDropdown.innerHTML = '<option value="">Select Client</option>';
        clients.forEach(client => {
            const opt = document.createElement('option');
            opt.value = client.ClientID; // Matches backend JSON field
            opt.textContent = client.ClientName;
            clientDropdown.appendChild(opt);
        });
        // Always reset project dropdown as well
        const projectDropdown = document.getElementById('newUserProject');
        projectDropdown.innerHTML = '<option value="">Select Project</option>';
    } catch (err) {
        console.error("Failed to load clients:", err);
    }
}

// Load projects for the selected client
async function loadProjectsForUserModal(clientId) {
    if (!clientId) return;
    try {
        const res = await fetch(`/getprojectsbyclient?clientid=${encodeURIComponent(clientId)}`);
        const projects = await res.json();
        const projectDropdown = document.getElementById('newUserProject');
        projectDropdown.innerHTML = '<option value="">Select Project</option>';
        if (Array.isArray(projects)) {
            projects.forEach(proj => {
                const opt = document.createElement('option');
                opt.value = proj.id; // Matches backend JSON field
                opt.textContent = proj.name;
                projectDropdown.appendChild(opt);
            });
        }
    } catch (err) {
        console.error("Failed to load projects:", err);
    }
}

// Attach event listeners after DOM fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Trigger client loading each time the modal is shown/opened
    const addUserBtn = document.querySelector(".btn-success, [data-action='addUser']");
    if (addUserBtn) {
        addUserBtn.addEventListener('click', function() {
            loadClientsForUserModal();
        });
    }

    // Bind to client dropdown for project dependent loading
    const clientDropdown = document.getElementById('newUserClient');
    if (clientDropdown) {
        clientDropdown.addEventListener('change', function() {
            loadProjectsForUserModal(this.value);
        });
    }
});


    window.onload = loadUsers;
  </script>
</body>
</html>
