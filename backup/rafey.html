<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ticket System</title>
 
  <style>
 
 
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      position: relative;
      background-color: #010b13;
      color: white;
      font-weight: bold;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.0em;
      padding: 0 20px;
    }
    .header-logo {
  height: 55px; /* ðŸ‘ˆ Increase this value (e.g., from 40px to 50px or more) */
  width: auto;
  margin-right: 10px;
}
 
 
    footer {
      background-color: #f1f1f1;
      color: #333;
      font-size: 0.9em;
      text-align: center;
      padding: 0px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
      text-align: center;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #f4f4f4;
      position: relative;
    }
    .badge {
      padding: 3px 8px;
      border-radius: 12px;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
      display: inline-block;
      min-width: 60px;
    }
    .badge.low { background-color: red; }
    .badge.medium { background-color: orange; }
    .badge.high { background-color: red; }
    .badge.open { background-color: #007bff; }
    .badge.closed { background-color: #6c757d; }
    .badge.in-progress { background-color: #ffc107; color: black; }
 
    button {
      padding: 6px 10px;
      margin-bottom: 10px;
      cursor: pointer;
      background-color: #020d19;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: small;
    }
    button:hover {
      background-color: #0056b3;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 500px;
      max-width: 90%;
      border-radius: 8px;
      box-shadow: 0 0 10px #00000055;
      max-height: 90vh;
      overflow-y: auto;
      font-size: 0.9rem;
    }
    .modal-content label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    .modal-content input,
    .modal-content select,
    .modal-content textarea {
      width: 100%;
      padding: 7px;
      box-sizing: border-box;
      font-size: 0.9rem;
    }
    .modal-content textarea {
      resize: vertical;
      min-height: 80px;
      font-size: 1rem;
    }
    .modal-footer {
      text-align: right;
      margin-top: 15px;
    }
    .modal-footer button {
      margin-left: 10px;
    }
    .image-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
    }
    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 0 20px #00000099;
      background: white;
    }
 
    /* ARM TICKETS label above Attachment column */
    .attachment-header-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .attachment-header-container .arm-tickets-label {
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: #020d19;
      cursor: default;
      user-select: none;
      background-color: #081b29;
      padding: 3px 10px;
      border-radius: 6px;
      color: white;
    }
 
    /* ARM logo above Edit column */
    .edit-header-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0px;
    }
    .edit-header-container img {
  width: 30px;
  height: 30px;
  object-fit: contain;
  margin-bottom: -8px; /* ðŸ‘ˆ Moved logo upward more */
}
 
 
    /* Bigger description column */
    td.description-cell {
      text-align: left;
      max-width: 300px;
      white-space: normal;
      word-wrap: break-word;
      font-size: 0.9rem;
    }
    th.description-header {
      max-width: 300px;
    }
 
    /* Filter container styling */
    .filter-container {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      font-size: small;
 
    }
    .filter-container label {
      font-weight: bold;
    }

.attachment-pin {
  display: inline-flex;
  align-items: center;
  transform: rotate(-135deg);
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s ease;
}
 
.horizontal-paperclip {
  transform: rotate(0deg); /* Force no rotation */
  transition: stroke 0.2s ease, transform 0.2s ease;
}
 
.attachment-pin:hover .horizontal-paperclip {
  stroke: #007bff;
  transform: scale(1.2);
}
 
 
.logout-button {
  background-color: #000000;
  color: #ffffff;
  border: 1.2px solid #ffffff;
  padding: 8px 10px;
  border-radius: 4px;
  font-size: 0.8em;
  font-weight: 550;
  cursor: pointer;
  margin-top: 7px; /* ðŸ‘ˆ This moves it slightly downward */
}
 
 
.logout-button:hover {
  background-color: #a80606;
}
 
 
 
/* Smaller but readable Date Logged and Closed Date columns */
th.date-logged-header,
td.date-logged-cell {
  min-width: 80px;
  max-width: 80px;
  white-space: nowrap;
}
 
th.closed-date-header,
td.closed-date-cell {
  min-width: 80px;
  max-width: 80px;
  white-space: nowrap;
}
 
  </style>
 
</head>
<body>
<header>
  <div style="display: flex; align-items: center; width: 100%;">
    <img src="/static/FINAL LOGO SAAIT.png" alt="Logo" class="header-logo" />
    <div class="header-title" style="flex-grow: 1; text-align: center; font-size: 23px; font-style: oblique;">
      SAAIT TICKETING SYSTEM
    </div>
    <button id="logoutBtn" class="logout-button">Logout</button>
  </div>
</header>
 
 
<div class="main-content">
  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
  <button id="addTicketBtn">Add Ticket</button>
  <button id="exportBtn">Export</button>
</div>
<div style="
  display: flex;
  justify-content: flex-end;
  margin-top: -50px;
  margin-bottom: 10px;
">
<label style="
  display: inline-block;
  padding: 6px 10px;
  margin-bottom: 10px;
  background-color: #020d19;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: small;
  font-family: Arial, sans-serif;
  line-height: normal;
  vertical-align: middle;
  margin-right: 10px; /* ðŸ‘ˆ Adjust this value as needed */
">
  ARM TICKETS
</label>
 
 
<img src="{{ url_for('static', filename='arm LOGO.jpeg') }}" alt="ARM Logo" style="height: 30px;" />
 
 
 
</div>
 
 
 <div style="display: flex; justify-content: center; margin-top: 20px;">
  <div class="filter-container" style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
    <label for="statusFilter">Status :</label>
    <select id="statusFilter">
      <option value="">All</option>
      <option value="Open">Open</option>
      <option value="In Progress">In Progress</option>
      <option value="Closed">Closed</option>
    </select>
 
    <label for="streamFilter">Stream :</label>
    <select id="streamFilter">
      <option value="">All</option>
      <option value="HCM">HCM</option>
      <option value="Finance">Finance</option>
      <option value="Leasing">Leasing</option>
      <option value="SCM">SCM</option>
      <option value="Pricing and Strategy">Pricing and Strategy</option>
      <option value="CXO">CXO</option>
      <option value="Leasing - Zoho">Leasing - Zoho</option>
      <option value="Other">Other</option>
    </select>
 
    <label for="priorityFilter">Priority :</label>
    <select id="priorityFilter">
      <option value="">All</option>
      <option value="Low">Low</option>
      <option value="Medium">Medium</option>
      <option value="High">High</option>
    </select>
 
    <label for="monthFilter">Month:</label>
    <select id="monthFilter">
      <option value="">All</option>
      <option value="01">January</option>
      <option value="02">February</option>
      <option value="03">March</option>
      <option value="04">April</option>
      <option value="05">May</option>
      <option value="06">June</option>
      <option value="07">July</option>
      <option value="08">August</option>
      <option value="09">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>
 
    <button id="clearFiltersBtn" style="
      padding: 6px 12px;
      font-size: small;
      background-color: #020d19;
      color: white;
      border: none;
      border-radius: 4px;
      height: 28px;
      margin-left: 10px;
    ">
      Clear
    </button>
  </div>
</div>
 
 
  <table style="margin-top: -20px; width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Dashboard</th>
        <th>Ticket No</th>
        <th>Stream</th>
        <th>Raised By</th>
        <th>Assigned To</th>
        <th>Subject</th>
        <th class="date-logged-header">Date Logged</th>
<th class="closed-date-header">Closed Date</th>
        <th>Priority</th>
        <th>Status</th>
       
        <th class="description-header">Description</th>
<th class="comments-header">Comments</th> <!-- âœ… Added this -->
<th>Attachment</th>
 
        <th>
          <div class="edit-header-container">
           
            Edit
          </div>
        </th>
       
      </tr>
    </thead>
    <tbody id="ticketTableBody"></tbody>
  </table>
</div>
 
<footer>
  <div>Powered by SAAIT</div>
</footer>
 
<div id="ticketModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Add Ticket</h3>
    <form id="ticketForm">
      <label>Stream</label>
      <select id="modalStream" required>
        <input type="text" id="customStream" placeholder="Enter custom stream" style="display:none; margin-top:5px;" />
    </select>
 
 
      <label>Dashboard</label>
      <select id="modalDashboard" required></select>
      <input type="text" id="customDashboard" placeholder="Enter custom dashboard" style="display:none; margin-top:5px;" />
 
 
      <label>Ticket No.</label>
      <input type="text" id="modalTicketNo" required readonly />
 
      <label for="modalRaisedBy">Raised By</label>
      <select id="modalRaisedBy" required>
        <option value="">Select User</option>
        <option>Sai Madhav</option>
        <option>Joyson</option>
        <option>Afroz</option>
        <option>Bryan</option>
        <option>Ajay</option>
        <option>Tanveer</option>
        <option>Sarfraz</option>
        <option>Jayesh</option>
        <option>Mario</option>
        <option>Sai</option>
        <option>Naved</option>
        <option>Afroz(mail)</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="customRaisedBy" placeholder="Enter name" style="display:none; margin-top:5px;" />
 
      <label>Assigned To</label>
      <select id="modalAssignedTo" required>
        <option value="">Select Assignee</option>
        <option>DREC TEAM</option>
        <option>ABRAR</option>
        <option>Tanveer</option>
        <option>Naved</option>
        <option>Shahid</option>
        <option>Sarfraz</option>
        <option>Sai Madhav</option>
        <option>Shyam (ARM Team)</option>
        <option>ARM Team</option>
        <option>Support</option>
        <option>ARM (Shyam) and SAAIT (Tanveer)</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="customAssignedTo" placeholder="Enter name" style="display:none; margin-top:5px;" />
 
     
 
      <label>Subject</label>
        <select id="modalSubject" required>
        <option value="">Select Subject</option>
        <option value="Dashboard completely down">Dashboard completely down</option>
        <option value="data breach">data breach</option>
        <option value="Impact on CXO">Impact on CXO</option>
        <option value="Visual issues">Visual issues</option>
        <option value="incorrect data">incorrect data</option>
        <option value="Enhancement requests">Enhancement requests</option>
        <option value="UI tweaks">UI tweaks</option>
        <option value="training queries">training queries</option>
        <option value="Technical support">Technical support</option>
        <option value="New dashboard Request">New dashboard Request</option>
        <option value="Other">Other</option>
      </select>
              <input type="text" id="customSubject" placeholder="Enter custom subject" style="display:none; margin-top:5px;"/>
     
       
      <label>Date Logged</label>
      <input type="date" id="modalDateLogged" required />
 
      <label>Closed Date</label>
      <input type="date" id="modalClosedDate" disabled />
 
      <label>Priority</label>
      <select id="modalPriority" required>
        <option value="">Select Priority</option>
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
      </select>
 
      <label>Status</label>
      <select id="modalStatus" required>
        <option value="">Select Status</option>
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Closed">Closed</option>
      </select>
 
      <label>Description</label>
<textarea id="modalDescription" rows="5" required></textarea>
 
<label>Comments</label>
<textarea id="modalComments" rows="3" placeholder="Optional comment..."></textarea>
 
<label>Attachment</label>
<input type="file" id="modalAttachment" accept="image/*" />
 
 
      <div class="modal-footer">
        <button type="button" id="modalCancelBtn">Cancel</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
</div>
 
<!-- Image preview modal -->
<div id="imageModal" class="image-modal">
  <img id="imageModalContent" src="" alt="Attachment Preview" />
</div>
 
<script>
  const TICKET_PREFIX = 'ARM';
  let tickets = [];
  let editingIndex = -1;
  const dashboardsByStream = {
      "Finance": [
        "All", "Master Matrics", "MIS P&L Analytics", "P&L Analytics MOM", "Revenue Analysis",
        "Revenue Analysis-BreakDown", "Revenue Details Table", "Revenue Waterfall Journey",
        "Direct Cost Waterfall Journey", "Indirect Cost Waterfall Journey", "Expense - Cost Category",
        "Expense - Break Down", "Expense - Utility Monthly", "Expense - Department",
        "Expense - Utility Building", "Expense Analytics - Details", "AR Aging Analysis",
        "Collection View", "Cheque Analysis"
      ],
      "Leasing": [
        "All", "Leasing Analytics", "Leasing Details", "Customer 360", "Asset 360", "Discount Analysis",
        "Lead Analysis", "Customer Complaint Status and Listing"
      ],
      "SCM": [
        "All", "PO Analysis", "Saving Analysis", "Spend Analysis", "Process SLA View",
        "Inventory Holding", "Capex/Non-Capex"
      ],
      "HCM": [
        "All", "Master Matrics", "Performance", "Employee 360"
      ],
      "Pricing and Strategy": [
        "All", "Portfolio Analysis", "Vacancy Analysis", "Rental Analysis",
        "Recommended Price Listing Analysis", "Payback & Transaction Analysis",
        "Rent Slab Analysis", "Strategic Analysis"
      ],
      "CXO": [
        "All", "Finance", "ARM Holding", "Leasing", "Facilities", "HCM", "Procurement"
      ],
      "Leasing - Zoho": [
        "All", "Leasing Revenue", "Leasing Status", "Leasing Unit Status"
      ],
      "Other": [
        "Other"
      ]
    };
 
 
  const addTicketBtn = document.getElementById('addTicketBtn');
  const ticketModal = document.getElementById('ticketModal');
  const ticketForm = document.getElementById('ticketForm');
  const ticketTableBody = document.getElementById('ticketTableBody');
 
  const modalStream = document.getElementById('modalStream');
  const modalDashboard = document.getElementById('modalDashboard');
  const modalTicketNo = document.getElementById('modalTicketNo');
  const modalRaisedBy = document.getElementById('modalRaisedBy');
  const modalSubject = document.getElementById('modalSubject');
  const customSubject = document.getElementById('customSubject');
  const modalDateLogged = document.getElementById('modalDateLogged');
  const modalClosedDate = document.getElementById('modalClosedDate');
  const modalPriority = document.getElementById('modalPriority');
  const modalStatus = document.getElementById('modalStatus');
  const modalAssignedTo = document.getElementById('modalAssignedTo');
  const modalDescription = document.getElementById('modalDescription');
  const modalAttachment = document.getElementById('modalAttachment');
 
  const statusFilter = document.getElementById('statusFilter');
  const streamFilter = document.getElementById('streamFilter');
  const priorityFilter = document.getElementById('priorityFilter');
  const monthFilter = document.getElementById('monthFilter');
 
  // Attach filters onchange
  statusFilter.onchange = renderTickets;
  streamFilter.onchange = renderTickets;
  priorityFilter.onchange = renderTickets;
  monthFilter.onchange = renderTickets;
 
  // âœ… Clear Filters Button Logic
document.getElementById('clearFiltersBtn').onclick = () => {
  statusFilter.value = '';
  streamFilter.value = '';
  priorityFilter.value = '';
  monthFilter.value = '';
  renderTickets();
};
 
  addTicketBtn.onclick = () => {
    editingIndex = -1;
    ticketForm.reset();
    customSubject.style.display = 'none';
    modalTicketNo.value = TICKET_PREFIX + (tickets.length + 101).toString();
    modalAssignedTo.value = '';
    modalClosedDate.value = '';
    modalClosedDate.disabled = true;
    modalDateLogged.valueAsDate = new Date();
    modalStatus.value = 'Open';
    modalPriority.value = '';
    modalStream.value = '';
    modalDashboard.innerHTML = '<option value="">Select Dashboard</option>';
    ticketModal.style.display = 'flex';
  };
 

  const customRaisedBy = document.getElementById('customRaisedBy');
const customAssignedTo = document.getElementById('customAssignedTo');

modalRaisedBy.onchange = () => {
  if (modalRaisedBy.value === 'Other') {
    customRaisedBy.style.display = 'block';
    customRaisedBy.required = true;
  } else {
    customRaisedBy.style.display = 'none';
    customRaisedBy.required = false;
    customRaisedBy.value = '';
  }
};

modalAssignedTo.onchange = () => {
  if (modalAssignedTo.value === 'Other') {
    customAssignedTo.style.display = 'block';
    customAssignedTo.required = true;
  } else {
    customAssignedTo.style.display = 'none';
    customAssignedTo.required = false;
    customAssignedTo.value = '';
  }
};

modalSubject.onchange = () => {
  if (modalSubject.value === 'Other') {
    customSubject.style.display = 'block';
    customSubject.required = true;
  } else {
    customSubject.style.display = 'none';
    customSubject.required = false;
    customSubject.value = '';
  }
};


modalStream.onchange = () => {
  const selectedStream = modalStream.value;
 
  // Show/hide custom stream input
  if (selectedStream === 'Other') {
    customStream.style.display = 'block';
    customStream.required = true;
 
    // Populate Dashboard with only "Other" option
    modalDashboard.innerHTML = '<option value="Other">Other</option>';
    modalDashboard.value = 'Other';
    customDashboard.style.display = 'block';
    customDashboard.required = true;
  } else {
    customStream.style.display = 'none';
    customStream.required = false;
 
    modalDashboard.innerHTML = '<option value="">Select Dashboard</option>';
 
    if (selectedStream && dashboardsByStream[selectedStream]) {
      dashboardsByStream[selectedStream].forEach(d => {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        modalDashboard.appendChild(option);
      });
    }
 
    // Always add "Other" option
    const otherOption = document.createElement('option');
    otherOption.value = 'Other';
    otherOption.textContent = 'Other';
    modalDashboard.appendChild(otherOption);
 
    // Hide custom dashboard input by default
    customDashboard.style.display = 'none';
    customDashboard.required = false;
  }
};
 
modalDashboard.onchange = () => {
  if (modalDashboard.value === 'Other') {
    customDashboard.style.display = 'block';
    customDashboard.required = true;
  } else {
    customDashboard.style.display = 'none';
    customDashboard.required = false;
  }
};
 
ticketForm.onsubmit = e => {
  e.preventDefault();
  let streamVal = modalStream.value === 'Other' ? customStream.value.trim() : modalStream.value;
if (!streamVal) {
  alert('Please select or enter a stream.');
  return;
}
 
 
  let subjectVal = modalSubject.value === 'Other' ? customSubject.value.trim() : modalSubject.value;
  if (!subjectVal) {
    alert('Please enter a subject.');
    return;
  }
 
  const formData = new FormData();
  let dashboardVal = modalDashboard.value === 'Other' ? customDashboard.value.trim() : modalDashboard.value;
if (!dashboardVal) {
  alert('Please enter a dashboard.');
  return;
}
  formData.append('dashboard', dashboardVal);
  formData.append('stream', streamVal);
  formData.append('subject', subjectVal);
  formData.append('date_logged', modalDateLogged.value);
  formData.append('closed_date', modalClosedDate.value || '');
  formData.append('priority', modalPriority.value);
  formData.append('status', modalStatus.value);
  formData.append('description', modalDescription.value.trim());
  formData.append('comment', modalComments.value.trim());
  const raisedByVal = modalRaisedBy.value === 'Other' ? customRaisedBy.value.trim() : modalRaisedBy.value;
  if (!raisedByVal) {
    alert('Please enter who raised the ticket.');
    return;
  }
  formData.append('raised_by', raisedByVal);

  const assignedToVal = modalAssignedTo.value === 'Other' ? customAssignedTo.value.trim() : modalAssignedTo.value;
  if (!assignedToVal) {
    alert('Please enter the assignee.');
    return;
  }
  formData.append('assigned_to', assignedToVal);

 
  if (modalAttachment.files.length > 0) {
    formData.append('attachment', modalAttachment.files[0]);
  }
 
 
  const isEditing = editingIndex !== -1;
  const endpoint = isEditing ? '/update_ticket' : '/add_ticket';
 
  if (isEditing) {
    formData.append('id', tickets[editingIndex].id);
    formData.append('ticket_no', tickets[editingIndex].ticketNo);
  }
 
  fetch(endpoint, {
    method: 'POST',
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      if (data.message) {
        alert(data.message + (data.ticket_no ? ' Ticket No: ' + data.ticket_no : ''));
        ticketModal.style.display = 'none';
        loadTicketsFromBackend();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(err => {
      console.error('âŒ Error submitting ticket:', err);
      alert('Failed to submit ticket.');
    });
};
 
function renderTickets() {
  const statusVal = statusFilter.value;
  const streamVal = streamFilter.value;
  const priorityVal = priorityFilter.value;
 function formatDate(isoDate) {
  if (!isoDate) return '-';
  const [year, month, day] = isoDate.split('-');
  return `${day}/${month}/${year}`;
}
 
  ticketTableBody.innerHTML = '';
 
  // Step 1: Filter tickets
  let filteredTickets = tickets.filter(ticket => {
    return (!statusVal || ticket.status === statusVal) &&
          (!streamVal || ticket.stream === streamVal) &&
          (!priorityVal || ticket.priority === priorityVal);
  });
 
  // Step 2: Sort tickets by status: Open â†’ In Progress â†’ Closed
  const statusOrder = { "Open": 1, "In Progress": 2, "Closed": 3 };
  filteredTickets.sort((a, b) => {
    return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
  });
 
  // Step 3: Render sorted & filtered tickets
  filteredTickets.forEach((ticket, i) => {
    const tr = document.createElement('tr');
 
    const badgePriority = document.createElement('span');
    badgePriority.className = 'badge ' + (ticket.priority.toLowerCase());
    badgePriority.textContent = ticket.priority;
 
    const badgeStatus = document.createElement('span');
    badgeStatus.className = 'badge ' + (ticket.status.toLowerCase().replace(/\s/g,'-'));
    badgeStatus.textContent = ticket.status;
 
    tr.innerHTML = `
      <td>${ticket.dashboard}</td>
      <td>${ticket.ticketNo}</td>
      <td>${ticket.stream}</td>
      <td>${ticket.raisedBy}</td>
      <td>${ticket.assignedTo}</td>
      <td>${ticket.subject}</td>
      <td class="date-logged-cell">${formatDate(ticket.dateLogged)}</td>
<td class="closed-date-cell">${formatDate(ticket.closedDate)}</td>
 
 
      <td></td> <!-- priority badge -->
      <td></td> <!-- status badge -->
      <td class="description-cell">${ticket.description}</td>
      <td class="description-cell">${(ticket.comments || '').replace(/\n/g, '<br>')}</td>
      <td></td> <!-- attachment -->
      <td><button data-index="${i}" class="editBtn">Edit</button></td>
    `;
 
    tr.children[8].appendChild(badgePriority);
    tr.children[9].appendChild(badgeStatus);
 
    if (ticket.attachment) {
      const imgThumb = document.createElement('img');
      imgThumb.src = ticket.attachment;
      imgThumb.alt = 'Attachment';
      imgThumb.style.height = '40px';
      imgThumb.style.cursor = 'pointer';
      imgThumb.onclick = () => openImageModal(ticket.attachment);
      tr.children[11].appendChild(imgThumb);
    } else {
      tr.children[11].textContent = '-';
    }
 
    ticketTableBody.appendChild(tr);
  });
 
  // Attach edit handlers
  document.querySelectorAll('.editBtn').forEach(btn => {
    btn.onclick = () => {
      const idx = +btn.dataset.index;
      openEditModal(idx);
    };
  });
}
function populateStreams() {
  // Clear previous options
  modalStream.innerHTML = '';
 
  // Add the default top option
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = 'Select Stream';
  modalStream.appendChild(defaultOption);
 
  // Build stream list with "Other" last
  const streamOptions = Object.keys(dashboardsByStream).filter(s => s !== 'Other');
  streamOptions.sort(); // Optional: sort alphabetically
  streamOptions.push('Other'); // Add 'Other' at the end
 
  // Add each stream option
  streamOptions.forEach(stream => {
    const option = document.createElement('option');
    option.value = stream;
    option.textContent = stream;
    modalStream.appendChild(option);
  });
}
 
  function openEditModal(idx) {
    editingIndex = idx;
    const ticket = tickets[idx];
 
    ticketForm.reset();
    customSubject.style.display = 'none';
 
    modalStream.value = ticket.stream;
    modalStream.onchange();
 
    modalDashboard.value = ticket.dashboard;
    modalTicketNo.value = ticket.ticketNo;
    modalRaisedBy.value = ticket.raisedBy;
    if (modalRaisedBy.querySelector(`option[value="${ticket.raisedBy}"]`)) {
      modalRaisedBy.value = ticket.raisedBy;
      customRaisedBy.style.display = 'none';
      customRaisedBy.required = false;
    } else {
      modalRaisedBy.value = 'Other';
      customRaisedBy.style.display = 'block';
      customRaisedBy.required = true;
      customRaisedBy.value = ticket.raisedBy;
    }
    
    modalAssignedTo.value = ticket.assignedTo;
    if (modalAssignedTo.querySelector(`option[value="${ticket.assignedTo}"]`)) {
      modalAssignedTo.value = ticket.assignedTo;
      customAssignedTo.style.display = 'none';
      customAssignedTo.required = false;
    } else {
      modalAssignedTo.value = 'Other';
      customAssignedTo.style.display = 'block';
      customAssignedTo.required = true;
      customAssignedTo.value = ticket.assignedTo;
    }
    
    if (modalSubject.querySelector(`option[value="${ticket.subject}"]`)) {
      modalSubject.value = ticket.subject;
      customSubject.style.display = 'none';
      customSubject.required = false;
      customSubject.value = '';
    } else {
      modalSubject.value = 'Other';
      customSubject.style.display = 'block';
      customSubject.required = true;
      customSubject.value = ticket.subject;
    }
 
    modalDateLogged.value = ticket.dateLogged;
    modalPriority.value = ticket.priority;
    modalStatus.value = ticket.status;
 
    if (ticket.status === 'Closed') {
      modalClosedDate.disabled = false;
      modalClosedDate.value = ticket.closedDate;
    } else {
      modalClosedDate.disabled = true;
      modalClosedDate.value = '';
    }
 
    modalDescription.value = ticket.description;
    document.getElementById('modalComments').value = '';
 
    modalAttachment.value = '';
 
    ticketModal.style.display = 'flex';
  }
 
  // Modal close button
  document.getElementById('modalCancelBtn').onclick = () => {
    ticketModal.style.display = 'none';
  };
 
  // Clicking outside modal closes it
  window.onclick = e => {
    if (e.target === ticketModal) ticketModal.style.display = 'none';
    if (e.target === imageModal) imageModal.style.display = 'none';
  };
 
  // Image preview modal
  const imageModal = document.getElementById('imageModal');
  const imageModalContent = document.getElementById('imageModalContent');
 
  function openImageModal(src) {
    imageModalContent.src = src;
    imageModal.style.display = 'flex';
  }
 
  renderTickets();
 // pin functions
function renderTickets() {
  const statusVal = statusFilter.value;
  const streamVal = streamFilter.value;
  const priorityVal = priorityFilter.value;
  const selectedMonth = monthFilter.value;
 
  function formatDate(isoDate) {
    if (!isoDate) return '-';
    const [year, month, day] = isoDate.split('-');
    return `${day}/${month}/${year}`;
  }
 
  function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}-${month}-${year}`;
 
}
 
  ticketTableBody.innerHTML = '';
 
  tickets
    .map((ticket, i) => ({ ticket, originalIndex: i })) // keep original index
    .filter(({ ticket }) => {
      const matchStatus = !statusVal || ticket.status === statusVal;
      const matchStream = !streamVal || ticket.stream === streamVal;
      const matchPriority = !priorityVal || ticket.priority === priorityVal;
 
      const dateLoggedMonth = ticket.dateLogged?.slice(5, 7);
      const closedDateMonth = ticket.closedDate?.slice(5, 7);
      const matchMonth = !selectedMonth || dateLoggedMonth === selectedMonth || closedDateMonth === selectedMonth;
 
      return matchStatus && matchStream && matchPriority && matchMonth;
    })
    .sort((a, b) => {
      const statusOrder = { "Open": 1, "In Progress": 2, "Closed": 3 };
      return (statusOrder[a.ticket.status] || 99) - (statusOrder[b.ticket.status] || 99);
    })
    .forEach(({ ticket, originalIndex }) => {
      const row = document.createElement('tr');
 
      row.innerHTML = `
        <td>${ticket.dashboard}</td>
        <td>${ticket.ticketNo}</td>
        <td>${ticket.stream}</td>
        <td>${ticket.raisedBy}</td>
        <td>${ticket.assignedTo}</td>
        <td>${ticket.subject}</td>
        <td>${formatDate(ticket.dateLogged)}</td>
        <td>${formatDate(ticket.closedDate)}</td>
        <td><span class="badge ${ticket.priority.toLowerCase()}">${ticket.priority}</span></td>
        <td><span class="badge ${ticket.status.toLowerCase().replace(' ', '-')}">${ticket.status}</span></td>
        <td class="description-cell">${ticket.description}</td>
        <td class="description-cell">${(ticket.comments || '').replace(/\n/g, '<br>')}</td>
        <td>
          ${ticket.attachment
            ? `<span class="attachment-pin" title="Click to view">
                 <svg xmlns="http://www.w3.org/2000/svg"
                      width="24" height="24" viewBox="0 0 24 24"
                      fill="none" stroke="#666" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round"
                      class="horizontal-paperclip">
                   <path d="M21.44 11.05l-8.49 8.49a5.5 5.5 0 0 1-7.78-7.78l9.19-9.19a3.5 3.5 0 0 1 4.95 4.95l-9.19 9.19a1.5 1.5 0 0 1-2.12-2.12l8.49-8.49"/>
                 </svg>
               </span>`
            : '-'}
        </td>
        <td><button onclick="editTicket(${originalIndex})">Edit</button></td>
      `;
 
      if (ticket.attachment) {
        const pin = row.querySelector('.attachment-pin');
        pin.onclick = () => openImageModal(ticket.attachment);
      }
 
      ticketTableBody.appendChild(row);
    });
}
 
// Close image preview modal on click
document.getElementById('imageModal').onclick = () => {
  document.getElementById('imageModal').style.display = 'none';
};
 
// Edit ticket (already part of your existing logic, ensure it's still present)
function editTicket(index) {
  editingIndex = index;
  const ticket = tickets[index];
 
  modalStream.value = ticket.stream;
  modalStream.dispatchEvent(new Event('change'));
 
  modalDashboard.value = ticket.dashboard;
  modalTicketNo.value = ticket.ticketNo;
  modalRaisedBy.value = ticket.raisedBy;
  modalSubject.value = dashboardsByStream[ticket.stream]?.includes(ticket.subject)
    ? ticket.subject
    : 'Other';
  customSubject.value = ticket.subject;
  customSubject.style.display = modalSubject.value === 'Other' ? 'block' : 'none';
  modalDateLogged.value = ticket.dateLogged;
  modalClosedDate.disabled = ticket.status !== 'Closed';
  modalClosedDate.value = ticket.closedDate;
  modalPriority.value = ticket.priority;
  modalStatus.value = ticket.status;
  modalAssignedTo.value = ticket.assignedTo;
  modalDescription.value = ticket.description;
 
  ticketModal.style.display = 'flex';
}
function loadTicketsFromBackend() {
  fetch('/get_tickets')
    .then(res => res.json())
    .then(data => {
      tickets = data.map(t => ({
        id: t.id,
        dashboard: t.dashboard,
        ticketNo: t.ticket_no,
        stream: t.stream,
        raisedBy: t.raised_by,
        subject: t.subject,
        dateLogged: t.date_logged,
        closedDate: t.closed_date,
        priority: t.priority,
        status: t.status,
        assignedTo: t.assigned_to,
        description: t.description,
        comments: t.comments,
        attachment: t.attachment
      }));
      renderTickets();
    })
    .catch(err => console.error('âŒ Error loading tickets:', err));
}
 
 
//pin functions end
 
document.getElementById('exportBtn').onclick = () => {
  const rows = [[
    'Dashboard', 'Ticket No', 'Stream', 'Raised By', 'Assigned To',
    'Subject', 'Date Logged', 'Closed Date', 'Priority', 'Status',
    'Description', 'Comments', 'Attachment'
  ]];

  const statusVal = statusFilter.value;
  const streamVal = streamFilter.value;
  const priorityVal = priorityFilter.value;
  const selectedMonth = monthFilter.value;

  tickets.forEach(ticket => {
    const matchStatus = !statusVal || ticket.status === statusVal;
    const matchStream = !streamVal || ticket.stream === streamVal;
    const matchPriority = !priorityVal || ticket.priority === priorityVal;
    const dateLoggedMonth = ticket.dateLogged?.slice(5, 7);
    const closedDateMonth = ticket.closedDate?.slice(5, 7);
    const matchMonth = !selectedMonth || dateLoggedMonth === selectedMonth || closedDateMonth === selectedMonth;

    if (matchStatus && matchStream && matchPriority && matchMonth) {
      rows.push([
        ticket.dashboard,
        ticket.ticketNo,
        ticket.stream,
        ticket.raisedBy,
        ticket.assignedTo,
        ticket.subject,
        ticket.dateLogged,
        ticket.closedDate,
        ticket.priority,
        ticket.status,
        ticket.description?.replace(/[\r\n]+/g, ' ') || '',
        ticket.comments?.replace(/[\r\n]+/g, ' ') || '',
        ticket.attachment || '-'
      ]);
    }
  });

  if (rows.length === 1) {
    alert("No tickets to export with current filters.");
    return;
  }

  const csvContent = rows.map(row =>
    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
  ).join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tickets_export.csv';
  a.click();
  URL.revokeObjectURL(url);
};
  
  document.getElementById('logoutBtn').onclick = () => {
  const confirmLogout = confirm("Are you sure you want to logout?");
  if (confirmLogout) {
    // Clear session data if needed (optional)
    // localStorage.clear();
 
    // Redirect to login page
    window.location.href = "/"; // or "/login.html" if login is a static file
  }
};

modalStatus.onchange = () => {
  if (modalStatus.value === 'Closed') {
    modalClosedDate.disabled = false;
    if (!modalClosedDate.value) {
      modalClosedDate.valueAsDate = new Date(); // auto-fill today's date
    }
  } else {
    modalClosedDate.disabled = true;
    modalClosedDate.value = '';
  }
};

window.addEventListener("load", () => {
  populateStreams();
  loadTicketsFromBackend();
});

modalStatus.onchange = () => {
  const today = new Date().toISOString().split('T')[0]; // Format: yyyy-mm-dd
 
  if (modalStatus.value === 'Closed') {
    modalClosedDate.disabled = false;
 
    // Set max attribute to today's date to prevent future dates
    modalClosedDate.max = today;
 
    // Auto-fill today's date if no value is set
    if (!modalClosedDate.value) {
      modalClosedDate.valueAsDate = new Date();
    }
  } else {
    modalClosedDate.disabled = true;
    modalClosedDate.value = '';
 
    // Remove max attribute when not in use
    modalClosedDate.removeAttribute('max');
  }
};
 
 
window.addEventListener("load", loadTicketsFromBackend);
 
 
</script>
</body>
</html>
